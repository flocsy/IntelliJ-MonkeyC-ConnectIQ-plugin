package com.github.bertware.monkeyc_intellij.highlighting;

import com.github.bertware.monkeyc_intellij.language.lexer.MonkeyLexer;
import com.github.bertware.monkeyc_intellij.language.parser.MonkeyTokenTypesSets;
import com.intellij.lexer.Lexer;
import com.intellij.openapi.editor.colors.TextAttributesKey;
import com.intellij.openapi.fileTypes.SyntaxHighlighterBase;
import com.intellij.psi.tree.IElementType;
import com.intellij.psi.tree.TokenSet;
import org.jetbrains.annotations.NotNull;

import java.util.Collections;
import java.util.HashMap;
import java.util.Map;
import com.github.bertware.monkeyc_intellij.language.psi.MonkeyTypes;
import static com.intellij.openapi.editor.DefaultLanguageHighlighterColors.*;
import static com.intellij.openapi.editor.colors.TextAttributesKey.createTextAttributesKey;

public class MonkeySyntaxHighlighter extends SyntaxHighlighterBase {
  public static final TextAttributesKey MC_LINE_COMMENT = TextAttributesKey.createTextAttributesKey("MC.LINE_COMMENT", LINE_COMMENT);
  public static final TextAttributesKey MC_LINE_DOC_COMMENT = TextAttributesKey.createTextAttributesKey("MC.LINE_DOC_COMMENT", DOC_COMMENT);
  public static final TextAttributesKey MC_BLOCK_COMMENT = TextAttributesKey.createTextAttributesKey("MC.BLOCK_COMMENT", BLOCK_COMMENT);
  public static final TextAttributesKey MC_CLASS_NAME = createTextAttributesKey("MC.CLASS_NAME", CLASS_NAME);
  public static final TextAttributesKey MC_FUNCTION_DECLARATION = createTextAttributesKey("MC.FUNCTION_DECLARATION", FUNCTION_DECLARATION);
  public static final TextAttributesKey MC_KEYWORD = createTextAttributesKey("MC.KEYWORD", KEYWORD);
  public static final TextAttributesKey MC_OPERATOR = createTextAttributesKey("MC.OPERATOR", OPERATION_SIGN);
  public static final TextAttributesKey MC_STRING = createTextAttributesKey("MC.STRING", STRING);
  public static final TextAttributesKey MC_NUMBER = createTextAttributesKey("MC.NUMBER", NUMBER);
  public static final TextAttributesKey MC_SYMBOL = createTextAttributesKey("MC.MC_SYMBOL", METADATA);
  public static final TextAttributesKey MC_CONSTANT = createTextAttributesKey("MC.CONSTANT", CONSTANT);

  private static final TokenSet OPERATOR_TOKENS = TokenSet.create(
    MonkeyTypes.PLUS,
    MonkeyTypes.SUB,
    MonkeyTypes.STAR,
    MonkeyTypes.SLASH
  );

  private static final TokenSet NUMBER_LITERALS = TokenSet.create(
    MonkeyTypes.INTLITERAL,
    MonkeyTypes.LONGLITERAL,
    MonkeyTypes.FLOATLITERAL,
    MonkeyTypes.DOUBLELITERAL,
    MonkeyTypes.HEX_LITERAL
  );

  private static final Map<IElementType, TextAttributesKey> TYPE_KEY_MAP = createTypeKeyMap();

  private static Map<IElementType, TextAttributesKey> createTypeKeyMap() {
    Map<IElementType, TextAttributesKey> aMap = new HashMap<>();
    fillMap(aMap, MonkeyTokenTypesSets.BUILT_IN_IDENTIFIERS, MC_KEYWORD);
    fillMap(aMap, OPERATOR_TOKENS, MC_OPERATOR);
    fillMap(aMap, MonkeyTokenTypesSets.STRINGS, MC_STRING);
    fillMap(aMap, NUMBER_LITERALS, MC_NUMBER);
    aMap.put(MonkeyTypes.SINGLE_LINE_COMMENT, MC_LINE_COMMENT);
    aMap.put(MonkeyTypes.SINGLE_LINE_DOC_COMMENT, MC_LINE_DOC_COMMENT);
    aMap.put(MonkeyTypes.BLOCK_COMMENT, MC_BLOCK_COMMENT);

    return Collections.unmodifiableMap(aMap);
  }

  @NotNull
  @Override
  public Lexer getHighlightingLexer() {
    return new MonkeyLexer();
  }

  @NotNull
  @Override
  public TextAttributesKey[] getTokenHighlights(IElementType tokenType) {
    return pack(TYPE_KEY_MAP.get(tokenType));
  }
}